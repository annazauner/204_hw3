---
title: "ESM 204 HW 3"
output: html_document
date: 'Anna Zauner, Kirsten White and Katherine Rosecrance'
---

```{r setup, include=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, options(scipen = 999))
library(tidyverse)
library(here)
library(janitor)
library(thematic)
library(scales)
library(equatiomatic)
library(rootSolve)
thematic::thematic_rmd()
thematic::thematic_on()
```


## Introduction

```{r}
# Read in the data 
data1 <- read_csv(here("data","HW3_data.csv")) %>% 
  clean_names() %>% 
  select(-x1)
```


The Biden Administration’s “interim” value is $51 per metric ton of CO2. In this analysis, we consider the distributional consequences of a household electricity tax based on the Social Cost of Carbon (SCC) to address the climate change problem.

Assumptions:

1. Consumers can separated into two income groups: “high” and “low.” 

2. Price ($) and quantity (kWh) estimates of demand per month for the two groups. 

3. Initially, there is no tax on electricity consumption.

4. The current electricity price (without any taxes) is $.10 per kWh.

5. The marginal cost of producing a kWh of electricity is linear and has a price-intercept of 0.


### **Question #1**

Calculating MEC

Assumptions:

1. One kWh of electricity emits 0.85 pounds of CO2 

2. Interim value of $51 per metric ton of CO2 

```{r}
# PIVOT LONGER WIH INCOME AS VARIABLE 

data_long <- data1 %>% 
  pivot_longer(cols = c(q_low_kwh, q_high_kwh),
               names_to = 'income',
               values_to = 'kwh') %>% 
  mutate(income = case_when(income == 'q_low_kwh' ~ 'low',
                   income == 'q_high_kwh' ~ 'high'))

# RUN CALCULATION FOR MEC

price_ton <- 51

# METRIC TON UNIT CONVERSION

price_lb <- price_ton/2205

price_lb

# UNIT CONVERSION 0.85 to get MEC/kWh

price_kWh <- price_lb*0.85

price_kWh

```

Based on the calculations, the MEC per kWh of electricity is **0.0197**.

git test


### **Question #2**

Calculating:

a. Aggregate monthly demand for electricity
b. Supply curve for electricity 
c. Benefit to consumers and producers under status quo
d. Environmental cost under status quo

**Low income demand** 

```{r}
# LM ESTIMATE FOR LOW INCOME

demand_low <- lm(price_cents ~ kwh, income =='low', 
                 data = data_long) 

demand_low
```

**High income demand**

```{r}

# LM ESTIMATE FOR HIGH INCOME

demand_high <- lm(price_cents ~ kwh, income =='high',
                  data = data_long) 

demand_high

```


**a. Aggregate monthly demand for electricity**

Sum high and low demand curves horizontally to get aggregate demand curve:

```{r}

# DEMAND AGG 

# need to rearrange the parameter to get Q(P)! 

# Qgg = Qlow(P) + Qlow(h) 

# Importantly, since they-intercepts are different, we know that Qagg(P) will have a kink. I include an ifelse() statement to take
# care of the kink.

# define a function to get demand

demand <- function(p, model){
  q <- (p - model$coefficients[[1]])/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
  return(q)}

demand_agg <- function(p){
  q <- demand(p, demand_low) + demand(p, demand_high)
  return(q)}

demand_agg(10)

# 536719.50 Kwh at $0.10

```

```{r}
# LM FROM VECTOR 
price = seq(0, 30, length.out = 100)
Qagg <- map(price, demand_agg) %>% 
  unlist()
agg_df<- tibble(Qagg = Qagg, price = price)
demand_agg_eq <- lm(price ~ Qagg, data = agg_df) 
extract_eq(model = demand_agg_eq, use_coefs = TRUE, coef_digits = 5)

# SWITCH Q ON ONE SIDE OF EQUATION
agg_slope <- demand_agg_eq$coefficients[2]
agg_int <- demand_agg_eq$coefficients[1]

agg_slope
agg_int

# AGG DEMAND FUNCTION is P = 29.78135 - 0.00004(Qagg) 
```

Demand function of the aggregate demand is:  **P = 29.78135 - 0.00004(Qagg)** 

**b. Supply curve for electricity** 

Now we need to calculate the supply curve for electricity. We already know that the current price is $0.10/kWh. We also know the MC for electricity is linear with a 0 intercept. 

```{r}

#536,719.5 kWh @ $0.10 CALCULATED ABOVE, INTERCEPT IS 0 

Qo_kWh <- demand_agg(10)

supply_slope <- 10/Qo_kWh

Qo_kWh

supply_slope

# SUPPLY FUNCTION is P = 0.0000186Q
```

The supply function is: **P = 0.0000186Q**


**c. Benefit to consumers and producers under status quo**

From this, we can calculate consumer and producer surplus as well as environmental cost. 

```{r}
# CALC CONSUMER SURPLUS

cs_base <- 0.5*Qo_kWh*(0.298 - 0.10)

cs_base

# $53135.23

# CALC PRODUCER SURPLUS

ps_base <- 0.5*Qo_kWh*0.10

ps_base

# $26,835.97

```

Consumer Benefit is calculated as $`r round(cs_base, 0)`
Producer Benefit is calculated as $`r round(ps_base, 0)`


**d. Environmental cost under status quo**


```{r}
env_cost_base <- price_kWh*Qo_kWh

env_cost_base

# $10,551.83
```

Environmental Cost calculated as $`r round(env_cost_base, 0)`


### **Question #3**

Calculating consumer benefit divided between "high" and "low" income consumers given total consumer surplus is $`r round(cs_base, 0)` at price of $0.10 per kWh. 


```{r}

#PLUG IN INTECEPT FROM LOW DEMAND CURVE TO CALCULATE TRIANGLE

cs_low <- 0.5*(.2337 - .10)*demand(10, demand_low)

cs_low

# $8,111.84 CS LOW INCOME

#PLUG IN INTECEPT FROM HIGH DEMAND CURVE TO CALCULATE TRIANGLE

cs_high <- 0.5*(.3161-.10)*demand(10, demand_high)

# $44,881.32 CS HIGH INCOME

cs_high
```

Consumer surplus for the high-income group **($`r round(cs_low, 0)`)** is significantly larger than the consumer surplus for the low-income group **( $`r round(cs_high, 0)`)** 


### **Question #4**

Deriving the optimal electricity tax (cents per kWh) with interim SCC. 
Assumptions:
- Low income group experience disproportionate share of impacts from climate change
- Climate externality is borne entirely by "low" income group

Calculating effects of tax on:

a. Amount of electricity produced and consumed
b. Price of electricity
c. Welfare of "high" income consumers
d. Welfare of "low" income consumers
e. Power suppliers 
f. Total environmental damage
g. Tax revenue generated

```{r}

# a. Amount of electricity produced and consumed

# OPTIMAL TAX is P of  MEC at Qo 

# ADD OPTIMAL TAX TO SUPPLY FUNCTION

#FIND Q* BY SETTING DEMAND AGG EQUAL TO SUPPLY+MEC



# b. Price of electricity

# FIND P* BY PLUGGING Q* INTO DEMAND AGG 



#c. Welfare of "high" income consumers

# FIND Q HIGH INCOME BY PLUGGING IN P* 

# USE NEW Q FOR HIGH INCOME TO CALCULATE WELFARE



#d. Welfare of "low" income consumers

# FIND Q LOW INCOME BY PLUGGING IN P* 

# USE NEW Q FOR HIGH INCOME TO CALCULATE WELFARE



# e. Power suppliers 

# FIND NEW P FOR SUPPLIERS GIVEN Q*




# f. Total environmental damage

# P* of MEC (0.019) TIMES Q*



# g. Tax revenue generated

# P* TIMES Q*


```



```{r}
mpc_q <- function(p) {p/supply_slope} # MPC in terms of Q

# DEMAND FUNCTION WITH TAX (SOLVED IN #1 MEC = $0.01965986 -> 1.97 cents)

dem_tax <- function(p, model){
  q <- (p - (model$coefficients[[1]]-1.97))/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
  return(q)
}
# AGG DEMAND FUNCTION w/ TAX
dem_agg_tax <- function(p){
  q <- dem_tax(p, demand_low) + dem_tax(p, demand_high)
  return(q)
}

# NEW EQUILIBRIUM 

uniroot(function(p)
  dem_agg_tax(p) - mpc_q(p),
        interval = c(0,20))

# a. Amount of electricity produced and consumed

# b. Price of electricity

#save new p
p_tax <- 9.31988

#generate new Q
q_tax <- dem_agg_tax(p_tax)

q_tax

#c. Welfare of "high" income consumers

demand_high_tax <- dem_tax(p_tax, demand_high)
cs_high_tax <- (0.5 * (.3161 - 0.0197 - (p_tax/100)) * demand_high_tax) - (demand_high_tax * 0.0197)

cs_high_tax

# d DOES NOT MAKE SENSE NEED HELP!!!!!!!!!!!

#d. Welfare of "low" income consumers

cs_low_tax_og <- cs_low - env_cost_base
demand_low_tax <- demand(p_tax, demand_low)
#Below is the total env cost at the new level of consumption
env_cost_tax <- price_kWh * q_tax
cs_low_tax <- (0.5 * (.2337 - 0.0197 - 0.0932) * demand_low_tax) - (demand_low_tax * 0.0197) - env_cost_tax

cs_low_tax


# e. Power suppliers 

# FIND NEW P FOR SUPPLIERS GIVEN Q*

q_tax <- dem_agg_tax(p_tax)

ps_tax <- 0.5*q_tax*0.0932

ps_tax

# f. Total environmental damage

# P* of MEC (0.0197) TIMES Q*

env_change <- env_cost_base - env_cost_tax

env_change

# g. Tax revenue generated

# P* TIMES Q*

tax_rev <- price_kWh*q_tax

tax_rev
```

a. Amount of electricity produced and consumed

New quantity of electricity: **($`r round(q_tax, 2)`)**

b. Price of electricity

New equilibrium price of electricity:  **($`r round(p_tax, 2)`)**

c. Welfare of "high" income consumers

$ **($`r round(cs_high_tax, 2)`)**

d. Welfare of "low" income consumers 

Decrease to: EDIT NEEDED $ **($`r round(welfare_low_tax, 2)`)**

e. Power suppliers surplus

Decrease to: $ **($`r round(ps_tax, 2)`)**

f. Total environmental damage

Decreases : $ **($`r round(env_change, 2)`)**

g. Tax revenue generated
 
$ **($`r round(tax_rev, 2)`)**


 - Welfare of low income consumers: 6,622.60 USD surplus minus a cumulative external cost of 9,854.20 USD borne entirely by low-income consumers results in a **net loss of 3,231.60 USD**

```

### **Question #5**

Assumptions:
- All tax revenue will be distributed to consumers in proportion to their pre-tax consumption
- True SCC may be much higher than $51 (range: $51, $75, $100, $125, $150 per metric ton of CO2)

Calculating effects of SCC-based electricity tax for:

a. Welfare of "high" income consumers
b. Welfare of "low" income consumers
c. Electricity producers



```{r}

```



### **Question #6**


```{r}

```


SANDY'S EXAMPLE CODE IF NEEDED

df <- read_csv("G:/My Drive/0UCSB_EES/3TA_Material/S22_ESM204/Homework 3/HW3_data.csv") %>% 
  select(-1) %>% 
  clean_names()

model_demand_l <- lm(price_cents  ~ q_low_kwh, data=df)
model_demand_h <- lm(price_cents ~ q_high_kwh, data=df)

# need to rearrange the parameter to get Q(P)! 

# Qgg = Qlow(P) + Qlow(h) 

# Importantly, since they-intercepts are different, we know that Qagg(P) will have a kink. I include an ifelse() statement to take
# care of the kink.

# define a function to get demand

demand <- function(p, model){
  q <- (p - model$coefficients[[1]])/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
  return(q)
}

# for each p level, return estimated aggregate demand
demand_agg <- function(p){
  q <- demand(p, model_demand_l) + demand(p, model_demand_h)
  return(q)
}

price = seq(0, 30, length.out = 100)
Qagg <- map(price, demand_agg) %>% unlist()

df<- tibble(Qagg = Qagg, price = price)

ggplot(df, aes(Qagg, price)) +
  geom_line()

# I also define functions for calculating the consumer surplus:

CS <- function(p, model){
  q <- demand(p, model)
  cs <- 0.5*(model$coefficients[[1]] - p)*q
  return(cs)
}

CS_agg <- function(p){
  cs <- CS(p,model_demand_l) + CS(p,model_demand_h)
  return(cs)
